{
    auto_https off
    email kkucukengin@gmail.com
}

:80 {
    encode gzip

    # MLflow API (strip only /mlflow, keep /api or /ajax-api)
    handle /mlflow/api* {
        uri strip_prefix /mlflow
        reverse_proxy mlflow:5000
    }
    handle /mlflow/ajax-api* {
        uri strip_prefix /mlflow
        reverse_proxy mlflow:5000
    }

    # MLflow UI & static (NO strip)
    handle /mlflow* {
        reverse_proxy mlflow:5000
    }

    # Grafana at /grafana (no strip)
    handle /grafana* {
        basic_auth {
            {$ADMIN_USER} {$ADMIN_HASH}
        }
        reverse_proxy grafana:3000
    }

    # Prometheus at /prometheus (no strip)
    handle /prometheus* {
        basic_auth {
            {$ADMIN_USER} {$ADMIN_HASH}
        }
        reverse_proxy prometheus:9090
    }

    # Default API at /
    reverse_proxy api:8000
}
