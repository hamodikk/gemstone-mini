{
    auto_https off
    email kkucukengin@gmail.com
}

:80 {
    encode gzip

    # --- MLflow API (strip only /mlflow, keep /api/...) ---
    @mlapi path /mlflow/api/*
    handle @mlapi {
        uri strip_prefix /mlflow
        reverse_proxy mlflow:5000 {
            header_up X-Forwarded-Prefix /mlflow
            header_up Host {host}
            header_up X-Forwarded-Proto {scheme}
        }
    }

    # --- MLflow AJAX (rewrite /mlflow/ajax-api/... -> /api/...) ---
    handle_path /mlflow/ajax-api/* {
        # after handle_path, {uri} is like /2.0/mlflow/...
        rewrite * /api{uri}
        reverse_proxy mlflow:5000 {
            header_up X-Forwarded-Prefix /mlflow
            header_up Host {host}
            header_up X-Forwarded-Proto {scheme}
        }
    }

    # --- MLflow UI & static (no strip) ---
    handle /mlflow* {
        reverse_proxy mlflow:5000 {
            header_up X-Forwarded-Prefix /mlflow
            header_up Host {host}
            header_up X-Forwarded-Proto {scheme}
        }
    }

    # Grafana
    handle /grafana* {
        basic_auth {
            {$ADMIN_USER} {$ADMIN_HASH}
        }
        reverse_proxy grafana:3000
    }

    # Prometheus
    handle /prometheus* {
        basic_auth {
            {$ADMIN_USER} {$ADMIN_HASH}
        }
        reverse_proxy prometheus:9090
    }

    # Default API
    reverse_proxy api:8000
}
